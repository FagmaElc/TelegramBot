import os
import random
import asyncio
from telegram import Update
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    ContextTypes, filters
)

# Обычные предсказания
predictions = [
    "{user1} и {user2} сегодня объединятся ради великой цели.",
    "Между {user1} и {user2} пробежит искра... или метеорит.",
    "{user1} узнает страшную тайну о {user2}.",
    "{user1} и {user2} случайно окажутся в одном лифте. Будет неловко.",
    "{user1} должен сегодня угостить {user2} пирожком.",
    "{user1} и {user2} — идеальная команда. Почти.",
    "{user1} сегодня наступит на ногу {user2}. Береги ноги!",
    "{user1} и {user2} не забудут этот день никогда.",
    "Сегодня не твой день. Завтра — тоже под вопросом.",
    "К тебе придёт просветление… но немного опоздает.",
    "Твоя интуиция сегодня в отпуске.",
    "Удача уже рядом. Но она идёт к другому.",
    "Сегодня ты звезда! Только не забудь выключить газ.",
    "Будущее туманно. Возможно, это чайник забыл выключить.",
    "Жди хороших новостей. Но не сильно жди.",
    "Тебя ждёт успех! Но сначала немного позора.",
    "Не бойся трудностей. Бойся пятницы без зарплаты.",
    "Всё будет хорошо. Но не сразу.",
    "Твоё счастье рядом. Просто ты его не видишь.",
    "Ты как кот: сам по себе, всем мешаешь, но милый.",
    "Твой уровень удачи — как у Wi-Fi в подвале.",
    "Ты на верном пути. Главное — не сворачивать в ближайший овраг.",
    "Будь собой. Остальные уже заняты… и немного успешнее.",
    "Ты рожден для великих дел. Просто пока никто не знает каких.",
    "Сегодня ты не тормоз… ты просто в режиме энергосбережения.",
    "Скоро будет знак. Главное — не пропусти его в ленте мемов.",
    "Звёзды говорят: хватит есть на ночь!",
    "Ты ближе к успеху, чем кажется. Успех просто ушёл без тебя.",
    "Скоро ты окажешься в центре внимания. Возможно, из-за падения.",
    "Сегодня ты как Wi-Fi — работает, но нестабильно.",
    "К тебе придёт вдохновение. Спрячь еду.",
    "Будущее светлое. Очки не забудь.",
    "Если бы удача была морковкой, ты — кролик без зубов.",
    "Твоё время придёт. Только не жди его стоя.",
    "Судьба улыбается тебе. Правда, с лёгкой насмешкой.",
    "Сегодня ты победитель. По крайней мере в «Камень-Ножницы-Бумага».",
    "Остерегайся людей в чёрном. Особенно налоговиков.",
    "Ты сияешь! Особенно после жирной пиццы.",
    "Скоро ты найдешь ответ. Вопрос — потеряешь.",
    "Космос слышит тебя. И ржёт.",
    "Сегодня можно всё! Но потом объяснишь полиции.",
    "Тебя ждёт встреча. С холодильником. Опять.",
    "Ты на грани… гениальности или бессмысленности — покажет время.",
    "Ты как Wi-Fi соседа — неуловим, но нужный.",
    "Жди знаков. Лучше, если дорожных.",
    "Будь собой… только в офлайн-режиме.",
    "Тебе повезёт. Почти.",
    "Сегодня идеальный день для чая и ничего не делания.",
    "Не грусти. Хуже будет только зимой.",
    "Ты звезда. Правда, далёкая и тусклая.",
    "Удача рядом. Но ты повернул не туда.",
    "Ты почти достиг цели. Осталось проснуться.",
    "Не пытайся всё контролировать. Даже телевизор тебя не слушается.",
    "Будь как понедельник: неожиданен и неизбежен.",
    "Сегодня ты магнит. Для странных людей.",
    "Ты — подарок судьбы. Без чека и упаковки.",
    "Скоро ты поймёшь важное. Но будет поздно.",
    "Ты сегодня на высоте. Особенно если в лифте.",
    "Будущее непредсказуемо. Особенно с тобой.",
    "Судьба даёт тебе шанс. Но ты спишь.",
    "Ты как будильник: всех бесишь, но без тебя нельзя.",
    "Улыбнись! Всё равно хуже не станет. Наверное.",
    "Ты как кофе без кофеина — странный, но живой.",
    "Пора что-то менять. Например, носки.",
    "Сегодня ты гений. Завтра — неизвестно.",
    "Ты в центре событий. Правда, никто не заметил.",
    "Судьба даёт тебе знак. Он — «Стоп».",
    "Не переживай. Все тоже делают вид, что знают, что делают.",
    "Ты на волне! Но это унитаз.",
    "Ты как идея в 3 ночи — сомнительный, но яркий.",
    "Сегодня — твой день. Только ты об этом ещё не знаешь.",
    "Ты светишься. Возможно, от стресса.",
    "Сегодня ты не проиграешь... потому что даже не попытаешься",
    "Твои мечты сбудутся... в следующей жизни",
    "Скоро ты узнаешь, что твоя популярность достигла максимума... в спаме",
    "Твой GPS сегодня приведёт тебя туда, куда ты не хотел... как и жизнь",
    "В этом году ты получишь столько же лайков, сколько и медицинских масок",
    "Твоя удача сегодня как Wi-Fi в метро - есть, но не поймать",
    "Скоро ты поймёшь, что твой потолок - это чей-то пол",
    "Твой гороскоп сегодня: 'Оставайся в постели... всем будет лучше'",
    "Сегодня ты не будешь одинок... бактерии в твоём кишечнике всегда с тобой",
    "Твоя зарплата растёт... как и твои расходы",
    "Скоро ты узнаешь, что твой spirit animal - это вымерший додо",
    "Твой счётчик шагов сегодня покажет ноль... как и твой прогресс",
    "В этом месяце ты станешь экспертом... в прокрастинации",
    "Твоя жизнь - как квест, где все двери заперты, а ключи продают за донат",
    "Скоро ты поймёшь, что твой тотем - это печенька 'попробуй ещё раз'",
    "Твой фитнес-браслет сегодня сдох... как и твоя мотивация",
    "Сегодня ты не проспишь... потому что не сможешь уснуть",
    "Твои планы на выходные: борьба с демонами прошлого и дошираком",
    "Скоро ты узнаешь, что твой внутренний голос врёт тебе",
    "Твой Netflix сегодня предложит тебе сериал... про твою жизнь под названием 'Провал'",
    "В этом году ты станешь звездой... падающей",
    "Твоя удача сегодня как биткоин - все о ней говорят, но никто не видел",
    "Скоро ты поймёшь, что твой потолок - это чей-то пол",
    "Твой бутерброд всегда падает маслом вниз... как и твои надежды",
    "Сегодня ты не будешь одинок... страх старости всегда с тобой",
    "Твоя карьера растёт... как грибы после дождя, но не так вкусно",
    "Скоро ты узнаешь, что твой дух-покровитель - это баг в матрице",
    "Твой счёт в банке сегодня выглядит как твои отношения: 'Нулевой баланс'",
"Скоро будет весело. Если ты это переживешь.",
    "Ты как пробка на трассе — мешаешь, но важен.",
    "Твоя интуиция говорит: «Отстань, я устала!»",
    "Ты на шаг ближе к мечте. Осталось только найти её.",
    "Ты на правильном пути. Жаль, он односторонний.",
    "Сегодня ты блистаешь! Но проверь, не потек ли хайлайтер.",
    "Будь как пельмени — горячий и в компании.",
    "Сегодня ты вне конкуренции. Потому что никто не участвует.",
    "Ты как баг в коде — неожиданно, но везде.",
    "Ты почти герой. Осталось подвиг придумать.",
    "Время действовать! Но не сегодня.",
    "Ты мог бы быть лучше. Но и так сойдёт.",
    "Ты родился, чтобы сиять! Где-то… когда-то…",
    "Будущее туманно. Возьми фонарик.",
    "Сегодня ты — как Wi-Fi в метро: есть, но толку мало.",
    "Твоя удача — как кот: приходит, когда хочет.",
    "Ты на пике формы. Круглой формы.",
    "Ты — как непонятный мем: неясно зачем, но смешно.",
    "Ты как обновление Windows — никто не ждал, но ты здесь.",
    "Твоя энергия бесконечна… пока ты спишь.",
    "Скоро всё станет ясно. Особенно, если включить свет.",
    "Ты сегодня не как все… и это пугает.",
    "Ты на высоте! Осторожно, не упади.",
    "Ты как Wi-Fi в деревне — редкий и ценный.",
    "Ты почти в порядке. Осталось чуть-чуть до нормы.",
    "Твоё будущее — как сюрприз в киндере: странное, но твоё.",
    "Сегодня ты блистателен. Главное — не ослепи начальство.",
    "Ты как зарядка на 1% — держишься, но ненадолго.",
    "Ты уникален. Особенно в очереди за шаурмой.",
    "Будь как кактус — колючий, но живой.",
    "Ты почти счастлив. Почти — ключевое слово.",
    "Тебя ждёт прорыв. Главное — не в трусах.",
    "Сегодня всё получится. Или почти всё. Или кое-что.","Сегодня удача улыбнётся… но не тебе.",
    "Не принимай всё близко к сердцу. Особенно еду. Это для желудка.",
    "Твоя звезда зажглась… и тут же перегорела.",
    "Судьба приготовила тебе сюрприз. Береги нервы.",
    "Ты как Wi-Fi в маршрутке — нестабилен, но присутствуешь.",
    "Скоро ты поймёшь, что всё это был сон… но нет, просто понедельник.",
    "Ты — как утро понедельника: тебя никто не ждал, но ты пришёл.",
    "Твой начальник сегодня будет добрым... в твоих фантазиях",
    "Твоя диета начнётся завтра... как и в прошлый раз",
    "Скоро ты поймёшь, что твоя молодость закончилась, когда начал кряхтеть, вставая с дивана",
    "Твой банковский счёт будет таким же пустым, как и твои обещания",
    "Сегодня ты не попадёшь в аварию... потому что машину не на что купить",
    "Твоя вторая половинка существует... в другом часовом поясе",
    "Скоро ты получишь повышение... уровня стресса",
    "Твой страх перед пауками наконец-то оправдается - один поселится в твоей ванной",
    "В этом году ты посетишь много новых мест... в своей голове",
    "Твой тост всегда будет падать маслом вниз... как и твоя самооценка",
    "Скоро ты поймёшь, что твой телефон умнее тебя... и красивее",
    "Твои New Year resolutions проживут меньше, чем майский жук на подоконнике",
    "Сегодня ты не опоздаешь... потому что тебя никто не ждёт",
    "Твой автобус всегда уезжает прямо перед твоим носом... как и молодость",
    "Скоро ты узнаешь, что твои друзья есть... в соцсетях у других людей",
    "Твой фитнес-браслет сегодня сдох... как и твоя сила воли",
    "Сегодня ты не проспишь... потому что тревога не даст",
    "Твои планы на выходные: борьба с демонами прошлого и дошираком",
    "Скоро ты узнаешь, что твой внутренний голос - твой главный тролль",
    "Твой Netflix сегодня предложит тебе сериал... 'Как я встретил твою депрессию'",
    "В этом году ты станешь звездой... падающей, как твои стандарты",
    "Твоя удача сегодня как биткоин - все о ней говорят, но у тебя её нет",
    "Скоро ты поймёшь, что твой потолок - это чей-то пол",
    "Твой бутерброд всегда падает маслом вниз... как и твоя продуктивность",
    "Сегодня ты не будешь одинок... тревожные мысли всегда с тобой",
    "Твоя карьера растёт... как грибы после дождя, но не так аппетитно",
    "Скоро ты узнаешь, что твой дух-покровитель - это глюк в матрице",
    "Твой счёт в банке сегодня выглядит как твои отношения: 'Недостаточно средств'",
    "В этом месяце ты станешь чемпионом... в прокрастинации",
    "Твоя жизнь - как плохой ситком, но без смеха",
    "Скоро ты поймёшь, что твой ангел-хранитель работает по контракту",
"Сегодня ты не умрёшь... но завтра не обещаю",
    "Твои растения проживут дольше, чем твои мечты",
    "Скоро ты поймёшь, что твой кот любит тебя только из-за еды",
    "Твой ангел-хранитель взял отпуск по уходу за другим человеком",
    "В этом году ты получишь столько же подарков, сколько и в прошлом - ноль",
    "Твой WiFi сегодня будет работать стабильнее, чем твои отношения",
    "Скоро ты найдёшь то, что не искал - новые морщины",
    "Твой банковский счёт будет таким же пустым, как и твоя душа",
    "Сегодня ты не попадёшь в аварию... потому что никуда не выйдешь",
    "Твоя диета начнётся завтра... как и в прошлый раз",
    "Скоро ты поймёшь, что твоя молодость закончилась, когда перестал понимать мемы",
    "Твой начальник сегодня будет добрым... в параллельной вселенной",
    "В этом месяце ты похудеешь... на сумму в кошельке",
    "Твоя вторая половинка существует... в твоих фантазиях",
    "Сегодня ты встретишь свою любовь... в зеркале",
    "Скоро ты получишь повышение... кровяного давления",
    "Твой страх перед пауками наконец-то оправдается",
    "В этом году ты посетишь много новых мест... в Google Maps",
    "Твой тост всегда будет падать маслом вниз... как и твоя жизнь",
    "Скоро ты поймёшь, что твой телефон умнее тебя",
    "Твои New Year resolutions проживут меньше, чем комнатное растение",
    "Сегодня ты не опоздаешь... потому что тебя никто не ждёт",
    "Твой автобус всегда уезжает прямо перед твоим носом... как и удача",
    "Скоро ты узнаешь, что твои друзья есть... у других людей",
    "Твой холодильник сегодня будет полнее, чем твоя личная жизнь",
    "В этом месяце ты станешь богаче... на опыт разочарований",
    "Твоя карма сегодня работает... но не в твою пользу",
    "Скоро ты поймёшь, что твоя лучшая половина - это диван",
    "Твой будильник сегодня не сработает... как и твои планы",
]

# Любовные предсказания
love_predictions = [
    "{user1} втайне влюблён(а) в {user2} 💘",
    "Судьба приготовила {user1} и {user2} романтическое приключение 🌹",
    "{user1} и {user2} сегодня начнут новую историю любви 📖",
    "{user1} скоро получит сердечко от {user2} ❤️",
    "Между {user1} и {user2} вспыхнет искра... держитесь 🔥",
    "{user1} и {user2} — идеальная парочка. Ну, почти 😏",
    "{user1} напишет роман про {user2}, но не признается 🤫",
    "{user1} и {user2} поедут вместе в отпуск... во сне 🏖️",
    "{user1} и {user2} сегодня задержатся в личных сообщениях дольше, чем планировали",
    "Кто-то из чата сегодня получит сообщение, которое перечитает трижды перед ответом",
    "Между {user1} и {user2} сегодня возникнет тот самый момент неловкого зрительного контакта",
    "{user1} случайно поставит сердечко на сообщение {user2} - 'случайно'",
    "Сегодня {user2} заметит, как {user1} особенно тщательно выбирает слова в переписке",
    "{user1} и {user2} обнаружат удивительно много общих интересов... слишком много",
    "Кто-то сегодня будет проверять онлайн-статус другого чаще, чем готов признать",
    "{user1} отправит {user2} песню, текст которой говорит сам за себя",
    "Сегодня в чате появится сообщение, после которого все вдруг замолчат на минуту",
    "{user2} неожиданно вспомнит смешной момент с {user1} и улыбнётся в неподходящий момент",
    "{user1} сегодня трижды проверит, не написал ли {user2}, прежде чем осознает это",
    "Кто-то из участников сегодня получит комплимент, который запомнит надолго",
    "Между {user1} и {user2} сегодня пробежит та самая 'дружеская' химия",
    "{user2} случайно использует смайлик с подтекстом в переписке с {user1}",
    "Сегодня {user1} будет смеяться над шутками {user2} чуть громче, чем над остальными",
    "{user1} и {user2} сегодня окажутся последними, кто покинет общий голосовой чат",
    "Кто-то сегодня поймает себя на мысли, что проверяет чат чаще, чем обычно",
    "{user2} невзначай упомянет {user1} в разговоре с друзьями сегодня вечером",
    "Сегодня {user1} заметит маленькую деталь во внешности {user2}, которую другие не видят",
    "{user1} и {user2} сегодня синхронно ответят на одно и то же сообщение",
    "Кто-то из чата сегодня отправит сообщение и сразу же начнёт переживать о тоне",
    "{user2} сегодня поймает себя на том, что ищет {user1} в общем списке участников",
    "Между {user1} и {user2} сегодня возникнет тот самый 'момент' в разговоре",
    "{user1} сегодня ответит на сообщение {user2} быстрее, чем обычно",
    "Сегодня {user2} использует слово, которое {user1} любит, совсем 'случайно'",
    "{user1} и {user2} сегодня обменяются взглядами, которые скажут больше слов",
    "Кто-то из участников сегодня получит сообщение, которое сохранит в избранное",
    "{user2} сегодня вспомнит маленькую деталь о {user1}, которую не должен был запомнить",
    "Сегодня {user1} будет перечитывать вчерашнюю переписку с {user2} с улыбкой",
    "{user1} и {user2} сегодня засмеются над шуткой, которую не поймут остальные",
    "Кто-то сегодня отправит сообщение и сразу же задумается: 'А не слишком ли это очевидно?'",
    "{user2} сегодня заметит, что {user1} изменил(а) фото профиля раньше всех",
    "Между {user1} и {user2} сегодня возникнет та самая 'неловкая' пауза, полная смысла",
    "{user1} сегодня 'случайно' упомянет {user2} в разговоре с общими друзьями",
    "Сегодня {user2} получит от {user1} сообщение, которое вызовет приятное волнение",
    "{user1} и {user2} сегодня обнаружат, что смотрят один и тот же сериал... странное совпадение",
    "Кто-то из чата сегодня будет стараться казаться остроумнее в переписке с определённым человеком",
    "{user2} сегодня зайдёт в профиль {user1} чаще, чем готов признать",
    "Сегодня {user1} поймает себя на мысли, что ждёт следующего сообщения от {user2}",
    "{user1} и {user2} сегодня синхронно используют один и тот же смайл",
    "Кто-то сегодня отправит сообщение, потом удалит, потом отправит снова",
    "{user2} сегодня заметит, как {user1} изменил(а) тон переписки, когда пишет ему/ей",
    "Между {user1} и {user2} сегодня пробежит та самая 'дружеская' энергетика",
    "{user1} сегодня вспомнит смешной момент с {user2} и улыбнётся в транспорте",
    "Сегодня {user2} получит от {user1} комплимент, который запомнит надолго",
]

chat_members = {}
chat_ids = set()  # сохраняем ID чатов, где бот активен

# Отслеживаем пользователей
async def track_user(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    user = update.effective_user

    chat_ids.add(chat_id)  # добавляем чат в список для автопостинга

    if chat_id not in chat_members:
        chat_members[chat_id] = set()

    username = f"@{user.username}" if user.username else user.full_name
    chat_members[chat_id].add(username)

# Команды
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Привет! Я Баба Маня. Напиши /prediction или /lovestory, чтобы узнать судьбу!")

async def prediction(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await send_prediction(update, context, predictions)

async def love_story(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await send_prediction(update, context, love_predictions)

# Общая функция отправки предсказания
async def send_prediction(update: Update, context: ContextTypes.DEFAULT_TYPE, source):
    chat_id = update.effective_chat.id
    members = list(chat_members.get(chat_id, []))
    if len(members) < 2:
        await update.message.reply_text("Мне нужно хотя бы два человека в чате, чтобы составить предсказание!")
        return
    user1, user2 = random.sample(members, 2)
    text = random.choice(source).format(user1=user1, user2=user2)
    await update.message.reply_text(text)

# Фоновый автопостинг
async def auto_post(app):
    await asyncio.sleep(10)  # подождём немного после запуска
    while True:
        for chat_id in chat_ids:
            members = list(chat_members.get(chat_id, []))
            if len(members) >= 2:
                user1, user2 = random.sample(members, 2)
                text = random.choice(predictions).format(user1=user1, user2=user2)
                try:
                    await app.bot.send_message(chat_id=chat_id, text=f"🔮 Предсказание: {text}")
                except Exception as e:
                    print(f"Ошибка при отправке в чат {chat_id}: {e}")
        await asyncio.sleep(300)  # 5 минут

# Основной запуск
def main():
    TOKEN = os.environ["BOT_TOKEN"]
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("prediction", prediction))
    app.add_handler(CommandHandler("lovestory", love_story))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, track_user))

    async def after_startup(app):
        asyncio.create_task(auto_post(app))

    app.post_init = after_startup

    print("🤖 Баба Маня запущена!")
    app.run_polling()

if __name__ == "__main__":
    main()
